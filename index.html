<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>micro:bit Accelerometer Data</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .data-card {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .axis-label {
            font-family: monospace;
            font-weight: bold;
        }
        /* Estilo para el nivel de burbuja */
        .bubble-container {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            border: 4px solid #475569;
            position: relative;
            background: #1e293b;
            margin: 0 auto;
        }
        #bubble {
            width: 20px;
            height: 20px;
            background: #22c55e;
            border-radius: 50%;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            box-shadow: 0 0 15px #22c55e;
            transition: all 0.1s ease-out;
        }
    </style>
</head>
<body class="bg-slate-900 text-white min-h-screen flex flex-col items-center p-6 font-sans">

    <div class="max-w-2xl w-full">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-black bg-gradient-to-r from-green-400 to-blue-500 bg-clip-text text-transparent mb-2">
                Monitor Acelerómetro
            </h1>
            <p class="text-slate-400">Lectura en tiempo real de los ejes X, Y, Z</p>
        </header>

        <!-- Estado y Conexión -->
        <div class="flex flex-col items-center gap-4 mb-8">
            <div id="statusBadge" class="px-4 py-1 rounded-full border border-red-500/50 bg-red-500/10 text-red-400 text-sm font-bold flex items-center gap-2">
                <span id="statusDot" class="w-2 h-2 rounded-full bg-red-500"></span>
                <span id="statusText">DESCONECTADO</span>
            </div>
            
            <button id="connectBtn" onclick="connect()" class="px-8 py-3 bg-blue-600 hover:bg-blue-500 rounded-2xl font-bold shadow-xl transition-all active:scale-95 flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m7 7 10 10-5 5V2l5 5L7 17"/></svg>
                Vincular micro:bit
            </button>
        </div>

        <!-- Visualización de Datos -->
        <div id="dataSection" class="hidden grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- Valores Numéricos -->
            <div class="data-card p-6 rounded-3xl space-y-6">
                <h2 class="text-slate-400 text-xs font-bold uppercase tracking-widest">Valores de los Ejes (milli-g)</h2>
                
                <div class="flex justify-between items-center">
                    <span class="axis-label text-red-400 text-xl">Eje X:</span>
                    <span id="valX" class="text-2xl font-mono">0</span>
                </div>
                <div class="w-full bg-slate-800 h-2 rounded-full overflow-hidden">
                    <div id="barX" class="bg-red-500 h-full transition-all" style="width: 50%"></div>
                </div>

                <div class="flex justify-between items-center">
                    <span class="axis-label text-green-400 text-xl">Eje Y:</span>
                    <span id="valY" class="text-2xl font-mono">0</span>
                </div>
                <div class="w-full bg-slate-800 h-2 rounded-full overflow-hidden">
                    <div id="barY" class="bg-green-500 h-full transition-all" style="width: 50%"></div>
                </div>

                <div class="flex justify-between items-center">
                    <span class="axis-label text-blue-400 text-xl">Eje Z:</span>
                    <span id="valZ" class="text-2xl font-mono">0</span>
                </div>
                <div class="w-full bg-slate-800 h-2 rounded-full overflow-hidden">
                    <div id="barZ" class="bg-blue-500 h-full transition-all" style="width: 50%"></div>
                </div>
            </div>

            <!-- Nivel de Burbuja Visual -->
            <div class="data-card p-6 rounded-3xl flex flex-col items-center justify-center space-y-4">
                <h2 class="text-slate-400 text-xs font-bold uppercase tracking-widest">Inclinación Visual</h2>
                <div class="bubble-container">
                    <div id="bubble"></div>
                    <div class="absolute top-1/2 w-full border-t border-slate-700/50"></div>
                    <div class="absolute left-1/2 h-full border-l border-slate-700/50"></div>
                </div>
                <p class="text-slate-500 text-xs text-center mt-2">Mueve la micro:bit para ver la burbuja desplazarse</p>
            </div>
        </div>

        <div id="errorMessage" class="hidden mt-6 p-4 bg-red-900/40 border border-red-500/50 rounded-2xl text-red-200 text-sm italic"></div>
    </div>

    <script>
        let device;
        // UUIDs estándar del servicio de acelerómetro de micro:bit
        const ACCEL_SERVICE_UUID = 'e95d0753-251d-470a-a062-fa1922dfa9a8';
        const ACCEL_DATA_CHAR_UUID = 'e95dca4b-251d-470a-a062-fa1922dfa9a8';
        const ACCEL_PERIOD_CHAR_UUID = 'e95dfb11-251d-470a-a062-fa1922dfa9a8';

        async function connect() {
            const errDiv = document.getElementById('errorMessage');
            errDiv.classList.add('hidden');

            try {
                device = await navigator.bluetooth.requestDevice({
                    filters: [{ namePrefix: 'BBC micro:bit' }],
                    optionalServices: [ACCEL_SERVICE_UUID]
                });

                const server = await device.gatt.connect();
                const service = await server.getPrimaryService(ACCEL_SERVICE_UUID);

                // Configurar frecuencia de actualización (ej: 80ms para suavidad)
                try {
                    const periodChar = await service.getCharacteristic(ACCEL_PERIOD_CHAR_UUID);
                    await periodChar.writeValue(new Uint16Array([80]));
                } catch (e) { console.log("Periodo no ajustable, usando default"); }

                const dataChar = await service.getCharacteristic(ACCEL_DATA_CHAR_UUID);
                
                // Empezar a recibir notificaciones
                await dataChar.startNotifications();
                dataChar.addEventListener('characteristicvaluechanged', handleAccelChange);

                // UI Update
                updateUIState(true);
                device.addEventListener('gattserverdisconnected', () => updateUIState(false));

            } catch (err) {
                errDiv.textContent = "Error: " + err.message;
                errDiv.classList.remove('hidden');
            }
        }

        function handleAccelChange(event) {
            const view = event.target.value;
            
            // La micro:bit envía 3 valores Int16 (X, Y, Z) en milli-g
            const x = view.getInt16(0, true);
            const y = view.getInt16(2, true);
            const z = view.getInt16(4, true);

            // Actualizar textos
            document.getElementById('valX').textContent = x;
            document.getElementById('valY').textContent = y;
            document.getElementById('valZ').textContent = z;

            // Actualizar barras (rango aprox de -2000 a 2000 milli-g)
            updateBar('barX', x);
            updateBar('barY', y);
            updateBar('barZ', z);

            // Actualizar burbuja (Inclinación)
            const bubble = document.getElementById('bubble');
            // Mapeamos el valor (aprox -1000 a 1000) a porcentaje (0 a 100)
            const posX = Math.max(0, Math.min(100, 50 + (x / 20)));
            const posY = Math.max(0, Math.min(100, 50 + (y / 20)));
            bubble.style.left = posX + '%';
            bubble.style.top = posY + '%';
        }

        function updateBar(id, val) {
            // Mapear de -2000/2000 a 0/100%
            let percent = ((val + 2000) / 4000) * 100;
            document.getElementById(id).style.width = Math.max(0, Math.min(100, percent)) + '%';
        }

        function updateUIState(connected) {
            const badge = document.getElementById('statusBadge');
            const dot = document.getElementById('statusDot');
            const text = document.getElementById('statusText');
            const dataSec = document.getElementById('dataSection');
            const connBtn = document.getElementById('connectBtn');

            if (connected) {
                badge.className = "px-4 py-1 rounded-full border border-green-500/50 bg-green-500/10 text-green-400 text-sm font-bold flex items-center gap-2";
                dot.className = "w-2 h-2 rounded-full bg-green-500 animate-pulse";
                text.textContent = "CONECTADO";
                dataSec.classList.remove('hidden');
                connBtn.classList.add('hidden');
            } else {
                badge.className = "px-4 py-1 rounded-full border border-red-500/50 bg-red-500/10 text-red-400 text-sm font-bold flex items-center gap-2";
                dot.className = "w-2 h-2 rounded-full bg-red-500";
                text.textContent = "DESCONECTADO";
                dataSec.classList.add('hidden');
                connBtn.classList.remove('hidden');
            }
        }

        async function disconnect() {
            if (device && device.gatt.connected) {
                device.gatt.disconnect();
            }
        }
    </script>
</body>
</html>
