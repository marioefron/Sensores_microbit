// ============================================
// MICRO:BIT ACCELEROMETER - VERSIÓN MEJORADA
// ============================================
// Esta versión garantiza que los datos se envíen correctamente

// PASO 1: Iniciar servicio Bluetooth
bluetooth.startUartService()

// PASO 2: Mostrar que está listo
basic.showIcon(IconNames.Heart)

// PASO 3: Variable para almacenar el JSON
let jsonData = ""

// PASO 4: Cuando se conecta Bluetooth
bluetooth.onBluetoothConnected(function () {
    basic.showIcon(IconNames.Yes)
    basic.pause(500)
    basic.clearScreen()
    // Enviar mensaje de confirmación
    bluetooth.uartWriteString("CONNECTED\n")
})

// PASO 5: Cuando se desconecta
bluetooth.onBluetoothDisconnected(function () {
    basic.showIcon(IconNames.No)
    basic.pause(500)
    basic.showIcon(IconNames.Heart)
})

// PASO 6: Loop principal - Enviar datos del acelerómetro
basic.forever(function () {
    // Leer valores del acelerómetro
    let x = input.acceleration(Dimension.X)
    let y = input.acceleration(Dimension.Y)
    let z = input.acceleration(Dimension.Z)
    
    // Construir JSON (forma más simple y segura)
    jsonData = "{\"accelerometer\":{\"x\":" + x + ",\"y\":" + y + ",\"z\":" + z + "}}"
    
    // Enviar por Bluetooth con salto de línea
    bluetooth.uartWriteString(jsonData + "\n")
    
    // Indicador visual opcional (parpadear LED esquina)
    led.plot(4, 0)
    
    // Pausa de 50ms (20 Hz)
    basic.pause(50)
    
    // Apagar LED
    led.unplot(4, 0)
})

// OPCIONAL: Ver valores con botones
input.onButtonPressed(Button.A, function () {
    basic.showNumber(input.acceleration(Dimension.X))
    basic.pause(1000)
    basic.clearScreen()
})

input.onButtonPressed(Button.B, function () {
    basic.showNumber(input.acceleration(Dimension.Y))
    basic.pause(1000)
    basic.clearScreen()
})

input.onButtonPressed(Button.AB, function () {
    basic.showNumber(input.acceleration(Dimension.Z))
    basic.pause(1000)
    basic.clearScreen()
})
